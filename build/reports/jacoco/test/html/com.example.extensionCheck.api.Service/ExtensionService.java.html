<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExtensionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">extensionCheck</a> &gt; <a href="index.source.html" class="el_package">com.example.extensionCheck.api.Service</a> &gt; <span class="el_source">ExtensionService.java</span></div><h1>ExtensionService.java</h1><pre class="source lang-java linenums">package com.example.extensionCheck.api.Service;

import com.example.extensionCheck.api.exception.ExtensionErrorCode;
import com.example.extensionCheck.api.exception.ExtensionException;
import com.example.extensionCheck.api.response.ExtensionListResponse;
import com.example.extensionCheck.api.validator.ExtensionValidator;
import com.example.extensionCheck.entity.ExtensionType;
import com.example.extensionCheck.entity.Extensions;
import com.example.extensionCheck.repository.ExtensionsRepository;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

<span class="fc" id="L21">@Slf4j</span>
@Service
@RequiredArgsConstructor
public class ExtensionService {

    private final ExtensionsRepository extRepository;
    private final SimpMessagingTemplate messagingTemplate;
    private final ExtensionValidator validator;

    private static final int MAX_CUSTOM_EXTENSIONS = 200;
    private static final String WEBSOCKET_TOPIC = &quot;/topic/extensions&quot;;

    /**
     * WebSocket으로 변경사항 브로드캐스트 (전체 데이터)
     */
    private void broadcastUpdate() {
<span class="fc" id="L37">        Map&lt;String, Object&gt; data = getActiveExtensionsMap();</span>
<span class="fc" id="L38">        data.put(&quot;type&quot;, &quot;full&quot;);</span>
<span class="fc" id="L39">        messagingTemplate.convertAndSend(WEBSOCKET_TOPIC, (Object) data);</span>
<span class="fc" id="L40">        log.debug(&quot;Broadcast full update&quot;);</span>
<span class="fc" id="L41">    }</span>

    /**
     * WebSocket으로 Delta 변경사항만 브로드캐스트
     */
    private void broadcastDeltaUpdate(List&lt;String&gt; fixedAdded, List&lt;String&gt; fixedRemoved) {
<span class="fc" id="L47">        Map&lt;String, Object&gt; delta = new HashMap&lt;&gt;();</span>
<span class="fc" id="L48">        delta.put(&quot;type&quot;, &quot;delta&quot;);</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">        delta.put(&quot;fixedAdded&quot;, fixedAdded != null ? fixedAdded : List.of());</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">        delta.put(&quot;fixedRemoved&quot;, fixedRemoved != null ? fixedRemoved : List.of());</span>
<span class="fc" id="L51">        messagingTemplate.convertAndSend(WEBSOCKET_TOPIC, (Object) delta);</span>
<span class="fc" id="L52">        log.debug(&quot;Broadcast delta update: added={}, removed={}&quot;, fixedAdded, fixedRemoved);</span>
<span class="fc" id="L53">    }</span>

    /**
     * 커스텀 확장자 추가
     */
    @Transactional
    public Extensions addExtension(String customExtension) {
<span class="fc" id="L60">        log.debug(&quot;Adding custom extension: {}&quot;, customExtension);</span>

        // 1. 기본 검증 (Validator 사용)
<span class="fc" id="L63">        validator.validate(customExtension);</span>

<span class="fc" id="L65">        String lowerExt = customExtension.toLowerCase();</span>

        // 2. 커스텀 확장자 개수 확인 (200개 제한)
<span class="fc" id="L68">        long customCount = extRepository.countByTypeAndIsActiveTrue(ExtensionType.CUSTOM);</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (customCount &gt;= MAX_CUSTOM_EXTENSIONS) {</span>
<span class="fc" id="L70">            throw new ExtensionException(ExtensionErrorCode.MAX_LIMIT_EXCEEDED);</span>
        }

        // 3. DB에서 고정 확장자 목록 조회하여 중복 체크
<span class="fc" id="L74">        List&lt;String&gt; fixedExtNames = extractNames(</span>
<span class="fc" id="L75">                extRepository.findAllByTypeAndIsActiveTrue(ExtensionType.FIXED)</span>
        );

<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (fixedExtNames.contains(lowerExt)) {</span>
<span class="fc" id="L79">            throw new ExtensionException(ExtensionErrorCode.FIXED_EXTENSION_CONFLICT);</span>
        }

        // 4. 기존 확장자 확인
<span class="fc" id="L83">        var existingExt = extRepository.findByName(lowerExt);</span>

<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (existingExt.isPresent()) {</span>
<span class="fc" id="L86">            Extensions ext = existingExt.get();</span>

            // 이미 활성화된 확장자면 중복 에러
<span class="fc bfc" id="L89" title="All 2 branches covered.">            if (ext.isActive()) {</span>
<span class="fc" id="L90">                throw new ExtensionException(ExtensionErrorCode.ALREADY_EXISTS);</span>
            }

            // 비활성화된 확장자면 다시 활성화
<span class="fc" id="L94">            ext.activate();</span>
<span class="fc" id="L95">            broadcastUpdate();</span>
<span class="fc" id="L96">            log.info(&quot;Reactivated extension: {}&quot;, lowerExt);</span>
<span class="fc" id="L97">            return ext;</span>
        }

        // 5. 새로운 커스텀 확장자 저장
<span class="fc" id="L101">        Extensions extensionsNew = Extensions.builder()</span>
<span class="fc" id="L102">                .name(lowerExt)</span>
<span class="fc" id="L103">                .isActive(true)</span>
<span class="fc" id="L104">                .type(ExtensionType.CUSTOM)</span>
<span class="fc" id="L105">                .build();</span>

<span class="fc" id="L107">        Extensions saved = extRepository.save(extensionsNew);</span>
<span class="fc" id="L108">        broadcastUpdate();</span>
<span class="fc" id="L109">        log.info(&quot;Created new extension: {}&quot;, lowerExt);</span>
<span class="fc" id="L110">        return saved;</span>
    }

    /**
     * 고정 확장자 저장 (체크박스 체크 시)
     */
    @Transactional
    public Extensions saveFixedExtension(String name) {
<span class="fc" id="L118">        String lowerName = name.toLowerCase();</span>
<span class="fc" id="L119">        log.debug(&quot;Saving fixed extension: {}&quot;, lowerName);</span>

<span class="fc" id="L121">        Extensions result = extRepository.findByNameAndType(lowerName, ExtensionType.FIXED)</span>
<span class="fc" id="L122">                .map(ext -&gt; {</span>
<span class="fc" id="L123">                    ext.activate();</span>
<span class="fc" id="L124">                    return ext;</span>
                })
<span class="fc" id="L126">                .orElseGet(() -&gt; {</span>
<span class="fc" id="L127">                    Extensions newExt = Extensions.builder()</span>
<span class="fc" id="L128">                            .name(lowerName)</span>
<span class="fc" id="L129">                            .isActive(true)</span>
<span class="fc" id="L130">                            .type(ExtensionType.FIXED)</span>
<span class="fc" id="L131">                            .build();</span>
<span class="fc" id="L132">                    return extRepository.save(newExt);</span>
                });

<span class="fc" id="L135">        broadcastUpdate();</span>
<span class="fc" id="L136">        return result;</span>
    }

    /**
     * 고정 확장자 삭제 (체크박스 해제 시)
     */
    @Transactional
    public void deleteFixedExtension(String name) {
<span class="fc" id="L144">        String lowerName = name.toLowerCase();</span>
<span class="fc" id="L145">        log.debug(&quot;Deleting fixed extension: {}&quot;, lowerName);</span>

<span class="fc" id="L147">        extRepository.findByNameAndType(lowerName, ExtensionType.FIXED)</span>
<span class="fc" id="L148">                .ifPresent(Extensions::deactivate);</span>

<span class="fc" id="L150">        broadcastUpdate();</span>
<span class="fc" id="L151">    }</span>

    /**
     * 활성화된 확장자 목록 조회 (DTO 반환)
     */
    public ExtensionListResponse getActiveExtensions() {
<span class="fc" id="L157">        List&lt;String&gt; fixedNames = extractNames(</span>
<span class="fc" id="L158">                extRepository.findAllByTypeAndIsActiveTrue(ExtensionType.FIXED)</span>
        );
<span class="fc" id="L160">        List&lt;String&gt; customNames = extractNames(</span>
<span class="fc" id="L161">                extRepository.findAllByTypeAndIsActiveTrue(ExtensionType.CUSTOM)</span>
        );

<span class="fc" id="L164">        return ExtensionListResponse.full(fixedNames, customNames);</span>
    }

    /**
     * 활성화된 확장자 목록 조회 (Map 반환 - WebSocket용)
     */
    public Map&lt;String, Object&gt; getActiveExtensionsMap() {
<span class="fc" id="L171">        List&lt;String&gt; fixedNames = extractNames(</span>
<span class="fc" id="L172">                extRepository.findAllByTypeAndIsActiveTrue(ExtensionType.FIXED)</span>
        );
<span class="fc" id="L174">        List&lt;String&gt; customNames = extractNames(</span>
<span class="fc" id="L175">                extRepository.findAllByTypeAndIsActiveTrue(ExtensionType.CUSTOM)</span>
        );

<span class="fc" id="L178">        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</span>
<span class="fc" id="L179">        result.put(&quot;fixed&quot;, fixedNames);</span>
<span class="fc" id="L180">        result.put(&quot;custom&quot;, customNames);</span>
<span class="fc" id="L181">        result.put(&quot;count&quot;, customNames.size());</span>
<span class="fc" id="L182">        return result;</span>
    }

    /**
     * 커스텀 확장자 비활성화
     */
    @Transactional
    public void deactivateExtension(String name) {
<span class="fc" id="L190">        log.debug(&quot;Deactivating extension: {}&quot;, name);</span>

<span class="fc" id="L192">        Extensions extension = extRepository.findByName(name)</span>
<span class="fc" id="L193">                .orElseThrow(() -&gt; new ExtensionException(ExtensionErrorCode.NOT_FOUND));</span>

<span class="fc" id="L195">        extension.deactivate();</span>
<span class="fc" id="L196">        broadcastUpdate();</span>
<span class="fc" id="L197">        log.info(&quot;Deactivated extension: {}&quot;, name);</span>
<span class="fc" id="L198">    }</span>

    /**
     * 고정 확장자 배치 업데이트 (여러 체크박스 한 번에 처리)
     */
    @Transactional
    public void batchUpdateFixed(List&lt;String&gt; checked, List&lt;String&gt; unchecked) {
<span class="fc" id="L205">        log.debug(&quot;Batch update: checked={}, unchecked={}&quot;, checked, unchecked);</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">        if (checked != null) {</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">            for (String name : checked) {</span>
<span class="fc" id="L209">                saveFixedExtensionInternal(name);</span>
<span class="fc" id="L210">            }</span>
        }

<span class="fc bfc" id="L213" title="All 2 branches covered.">        if (unchecked != null) {</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">            for (String name : unchecked) {</span>
<span class="fc" id="L215">                deleteFixedExtensionInternal(name);</span>
<span class="fc" id="L216">            }</span>
        }

<span class="fc" id="L219">        broadcastDeltaUpdate(checked, unchecked);</span>
<span class="fc" id="L220">    }</span>

    /**
     * 고정 확장자 저장 (내부용, 브로드캐스트 없음)
     */
    private void saveFixedExtensionInternal(String name) {
<span class="fc" id="L226">        String lowerName = name.toLowerCase();</span>

<span class="fc" id="L228">        extRepository.findByNameAndType(lowerName, ExtensionType.FIXED)</span>
<span class="fc" id="L229">                .ifPresentOrElse(</span>
                        Extensions::activate,
                        () -&gt; {
<span class="fc" id="L232">                            Extensions newExt = Extensions.builder()</span>
<span class="fc" id="L233">                                    .name(lowerName)</span>
<span class="fc" id="L234">                                    .isActive(true)</span>
<span class="fc" id="L235">                                    .type(ExtensionType.FIXED)</span>
<span class="fc" id="L236">                                    .build();</span>
<span class="fc" id="L237">                            extRepository.save(newExt);</span>
<span class="fc" id="L238">                        }</span>
                );
<span class="fc" id="L240">    }</span>

    /**
     * 고정 확장자 삭제 (내부용, 브로드캐스트 없음)
     */
    private void deleteFixedExtensionInternal(String name) {
<span class="fc" id="L246">        String lowerName = name.toLowerCase();</span>

<span class="fc" id="L248">        extRepository.findByNameAndType(lowerName, ExtensionType.FIXED)</span>
<span class="fc" id="L249">                .ifPresent(Extensions::deactivate);</span>
<span class="fc" id="L250">    }</span>

    /**
     * Extensions 리스트에서 이름만 추출
     */
    private List&lt;String&gt; extractNames(List&lt;Extensions&gt; extensions) {
<span class="fc" id="L256">        return extensions.stream()</span>
<span class="fc" id="L257">                .map(Extensions::getName)</span>
<span class="fc" id="L258">                .collect(Collectors.toList());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>